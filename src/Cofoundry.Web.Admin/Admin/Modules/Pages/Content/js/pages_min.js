angular.module("cms.pages",["ngRoute","cms.shared"]).constant("_",window._).constant("pages.modulePath","/Admin/Modules/Pages/Js/");
angular.module("cms.pages").config(["$routeProvider","shared.routingUtilities","pages.modulePath",function(e,i,a){a=i.mapOptions.bind(null,a);e.when("/new",a("AddPage")).when("/:id",a("PageDetails")).otherwise(a("PageList"))}]);
angular.module("cms.pages").factory("pages.customEntityService",["$http","shared.serviceBase",function(t,e){var r={getAllRoutingRules:function(){return t.get(e+"custom-entity-routing-rules/")}};return r}]);
angular.module("cms.pages").factory("pages.directoryService",["$http","_","shared.serviceBase",function(e,r,t){var a={},c=t+"page-directories";return a.getAll=function(){return e.get(c)},a}]);
angular.module("cms.pages").factory("pages.pageTemplateService",["$http","$q","shared.serviceBase",function(e,r,t){var a={},n=t+"page-templates";return a.getAll=function(){var t=r.defer();return e.get(n).then(function(e){t.resolve(e.items)},t.reject),t.promise},a}]);
angular.module("cms.pages").controller("ChangePageUrlController",["$scope","$q","$location","shared.LoadState","shared.pageService","pages.customEntityService","options","close",function(o,t,e,a,n,r,l,i){var u=t.defer(),s=t.defer();function c(){o.submitLoadState.on(),n.updateUrl(o.command).then(l.onSave).then(i).finally(o.submitLoadState.off)}(function(){var e=l.page,t=e.pageRoute;o.isCustomEntityRoute="CustomEntityDetails"===t.pageType,o.page=e,o.command={pageId:e.pageId,localeId:t.locale?t.locale.localeId:void 0,pageDirectoryId:t.pageDirectory.pageDirectoryId},o.isCustomEntityRoute?o.command.customEntityRoutingRule=t.urlPath:o.command.urlPath=t.urlPath})(),o.submitLoadState=new a,o.formLoadState=new a(!0),o.save=c,o.close=i,o.localesLoaded=u.resolve,o.pageDirectoriesLoaded=s.resolve,o.formLoadState.offWhen(u,s,function(){if(o.isCustomEntityRoute)return r.getAllRoutingRules().then(function(e){o.routingRules=e});var e=t.defer();return e.resolve(),e}())}]);
angular.module("cms.pages").controller("DuplicatePageController",["$scope","$q","$location","shared.stringUtilities","shared.LoadState","shared.pageService","pages.customEntityService","options","close",function(o,t,a,e,i,n,l,r,s){var u=t.defer(),c=t.defer();function d(){o.isCustomEntityRoute||(o.command.urlPath=e.slugify(o.command.title))}function m(){o.submitLoadState.on(),n.duplicate(o.command).then(g).then(s).finally(o.submitLoadState.off)}function g(e){a.path("/"+e)}(function(){var e=r.page,t=e.pageRoute;o.isCustomEntityRoute="CustomEntityDetails"===t.pageType,o.page=e,o.command={pageToDuplicateId:e.pageId,localeId:t.locale?t.locale.localeId:void 0,pageDirectoryId:t.pageDirectory.pageDirectoryId,title:"Copy of "+e.latestVersion.title},o.isCustomEntityRoute?o.command.customEntityRoutingRule=t.urlPath:d()})(),o.submitLoadState=new i,o.formLoadState=new i(!0),o.save=m,o.close=s,o.onTitleChanged=d,o.localesLoaded=u.resolve,o.pageDirectoriesLoaded=c.resolve,o.formLoadState.offWhen(u,c,function(){if(o.isCustomEntityRoute)return l.getAllRoutingRules().then(function(e){o.routingRules=e});var e=t.defer();return e.resolve(),e}())}]);
angular.module("cms.pages").controller("AddPageController",["_","$q","$location","$window","shared.LoadState","shared.stringUtilities","shared.urlLibrary","shared.pageService","pages.pageTemplateService","pages.customEntityService",function(t,e,a,n,o,l,i,d,s,r){var u=this,c=e.defer(),g=e.defer();function f(e,a){var n=e?(u.command.publish=!0,u.saveAndPublishLoadState):u.saveLoadState;e=n,u.globalLoadState.on(),e&&t.isFunction(e.on)&&e.on(),d.add(u.command).then(a).finally(function(e){u.globalLoadState.off(),e&&t.isFunction(e.off)&&e.off()}.bind(null,n))}function p(e){a.path("/"+e)}function h(e){return d.getById(e).then(function(e){n.location.href=i.visualEditorForPage(e.pageRoute,!0)})}function m(){u.command.urlPath=l.slugify(u.command.title)}function v(){var e=u.command.pageType,e="CustomEntityDetails"==e?e:"Generic";u.pageTemplates=t.where(u.allPageTemplates,{pageType:e})}function L(){a.path("/")}u.save=f.bind(null,!1,p),u.saveAndPublish=f.bind(null,!0,p),u.saveAndEdit=f.bind(null,!1,h),u.cancel=L,u.onNameChanged=m,u.onPageTypeChanged=v,u.globalLoadState=new o,u.saveLoadState=new o,u.saveAndPublishLoadState=new o,u.formLoadState=new o(!0),u.onLocalesLoaded=c.resolve,u.onPageDirectoriesLoaded=g.resolve,function(){u.pageTypes=d.getPageTypes(),u.command={showInSiteMap:!0,pageType:u.pageTypes[0].value};var e=s.getAll().then(function(e){u.allPageTemplates=e}),a=r.getAllRoutingRules().then(function(e){u.routingRules=e});u.formLoadState.offWhen(c,g,e,a).then(v)}()}]);
angular.module("cms.pages").controller("PageDetailsController",["$routeParams","$q","$location","_","shared.LoadState","shared.SearchQuery","shared.modalDialogService","shared.entityVersionModalDialogService","shared.urlLibrary","shared.pageService","shared.permissionValidationService","pages.modulePath",function(a,t,e,n,o,i,r,s,u,l,d,c){var p=this;function h(){p.editMode=!0,p.mainForm.formStatus.clear()}function g(e){e=e?(p.updateDraftCommand.publish=!0,p.saveAndPublishLoadState):p.saveLoadState;R(e),l.update(p.updatePageCommand).then(l.updateDraft.bind(this,p.updateDraftCommand)).then(C.bind(null,"Changes were saved successfully")).finally(k.bind(null,e))}function f(){p.editMode=!1,p.updatePageCommand=V(p.page),p.updateDraftCommand=G(p.page),p.mainForm.formStatus.clear()}function m(){s.publish(p.page.pageId,R).then(C.bind(null,"Page published successfully.")).catch(k)}function b(){s.unpublish(p.page.pageId,R).then(C.bind(null,"The page has been unpublished and reverted to draft state.")).catch(k)}function P(){var e={title:"Discard Version",message:"Are you sure you want to discard this draft? This will discard all changes since the page was last published.",okButtonTitle:"Yes, discard it",onOk:function(){return R(),l.removeDraft(p.page.pageId)}};r.confirm(e).then(C.bind(null,"Draft discarded successfully"))}function S(e){s.copyToDraft(p.page.pageId,e.pageVersionId,p.page.pageRoute.hasDraftVersion,R).then(function(){C("Draft created successfully.")}).catch(k)}function v(){var e={title:"Delete Page",message:"Are you sure you want to delete this page?",okButtonTitle:"Yes, delete it",onOk:function(){return R(),l.remove(p.page.pageId).then(M).catch(k)}};r.confirm(e)}function D(){r.show({templateUrl:c+"Routes/Modals/DuplicatePage.html",controller:"DuplicatePageController",options:{page:p.page}})}function y(){r.show({templateUrl:c+"Routes/Modals/ChangePageUrl.html",controller:"ChangePageUrlController",options:{page:p.page,onSave:C.bind(null,"Url Changed")}})}function C(e,a){return w(a).then(p.mainForm.formStatus.success.bind(null,e))}function w(e){return t.all([l.getById(a.id).then(function(e){return p.page=e,p.updatePageCommand=V(e),p.updateDraftCommand=G(e),p.editMode=!1,p.isMarkedPublished="Published"==p.page.pageRoute.publishStatus,p.publishStatusLabel=F(e.pageRoute),e}),I()]).then(function(e){U(e[1])}).then(k.bind(null,e))}function L(){return p.versionsLoadState.on(),I().then(U).then(k.bind(null,p.versionsLoadState))}function I(){return l.getVersionsByPageId(a.id,p.versionsQuery.getParameters())}function U(e){var a=p.page,t=a.pageRoute.isPublished();n.each(e.items,function(e){e.versionLabel=function(e,a){if("Draft"==e.workFlowStatus)return e.workFlowStatus;var t="V"+e.displayVersion;return e.isLatestPublishedVersion?t+" ("+F(a)+")":t}(e,a.pageRoute),e.browseUrl=p.urlLibrary.visualEditorForVersion(a.pageRoute,e,!1,t)}),p.versions=e}function F(e){return"Published"==e.publishStatus&&e.publishDate<Date.now()?"Pending Publish":e.publishStatus}function V(e){return{pageId:e.pageId,tags:e.tags}}function G(e){var a=e.latestVersion,t=a.openGraph;return{pageId:e.pageId,title:a.title,metaDescription:a.metaDescription,openGraphTitle:t.title,openGraphDescription:t.description,openGraphImageId:t.image?t.image.ImageAssetId:void 0,showInSiteMap:a.showInSiteMap}}function M(){e.path("")}function R(e){p.globalLoadState.on(),e&&n.isFunction(e.on)&&e.on()}function k(e){p.globalLoadState.off(),e&&n.isFunction(e.off)&&e.off()}p.edit=h,p.save=g.bind(null,!1),p.saveAndPublish=g.bind(null,!0),p.cancel=f,p.publish=m,p.unpublish=b,p.discardDraft=P,p.copyToDraft=S,p.deletePage=v,p.duplicatePage=D,p.changeUrl=y,p.editMode=!1,p.globalLoadState=new o,p.saveLoadState=new o,p.saveAndPublishLoadState=new o,p.formLoadState=new o(!0),p.versionsLoadState=new o,p.urlLibrary=u,p.versionsQuery=new i({onChanged:L,useHistory:!1,defaultParams:{pageSize:6}}),p.canCreate=d.canCreate("COFPGE"),p.canUpdate=d.canUpdate("COFPGE"),p.canDelete=d.canDelete("COFPGE"),p.canPublishPage=d.hasPermission("COFPGEPAGPUB"),p.canUpdatePageUrl=d.hasPermission("COFPGEUPDURL"),w(p.formLoadState)}]);
angular.module("cms.pages").controller("PageListController",["_","shared.entityVersionModalDialogService","shared.LoadState","shared.SearchQuery","shared.pageService","shared.permissionValidationService","pages.pageTemplateService",function(a,t,e,n,i,l,r){var o=this;function s(e){o.isFilterVisible=a.isUndefined(e)?!o.isFilterVisible:e}function d(e){t.publish(e,o.globalLoadState.on).then(u).then(o.globalLoadState.off).catch(o.globalLoadState.off)}function g(){s(!1),u()}function u(){return o.gridLoadState.on(),i.getAll(o.query.getParameters()).then(function(e){o.result=e,o.gridLoadState.off()})}o.publishStatus=[{name:"Unpublished"},{name:"Published"}],r.getAll().then(function(e){o.pageTemplates=e}),o.gridLoadState=new e,o.globalLoadState=new e,o.query=new n({onChanged:g}),o.filter=o.query.getFilters(),o.toggleFilter=s,s(!1),o.publish=d,o.canCreate=l.canCreate("COFPGE"),o.canUpdate=l.canUpdate("COFPGE"),u()}]);